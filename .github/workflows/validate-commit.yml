name: validate-commit
on: [push]

jobs:
  validate-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Report branch info
        run: echo "Detected push to ${{ github.ref }} by $GITHUB_ACTOR"

      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Validate the plugin
        id: validate
        run: |
          python3 missingCardFinder.py > output.txt 2>&1
          FILESIZE=$(wc -c < output.txt)
          if [ "$FILESIZE" -ne 0 ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi
          cat output.txt


      - name: Check for output
        id: check
        run: |
          FILESIZE=$(wc -c < output.txt)
          echo "filesize=$FILESIZE" >> "$GITHUB_OUTPUT"

      - name: Find Discord user
        id: discord
        run: |
          USERCODE=$(jq -r --arg actor "$GITHUB_ACTOR" '.[$actor]' .github/workflows/usernames.json)
          echo "discord_name=$USERCODE" >> "$GITHUB_OUTPUT"

      - name: Check previous workflow result
        id: previous
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREV_CONCLUSION=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${{ github.repository }}/actions/workflows/validate-commit.yml/runs?branch=${{ github.ref_name }}" | jq -r '.workflow_runs[1].conclusion')

          if [ "$PREV_CONCLUSION" = "failure" ]; then
            echo "previous_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "previous_failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Debug outputs
        run: |
          echo "validate.failed = '${{ steps.validate.outputs.failed }}'"
          echo "check.filesize = '${{ steps.check.outputs.filesize }}'"
          echo "previous.previous_failed = '${{ steps.previous.outputs.previous_failed }}'"


      - name: Send error discord message
        if: steps.validate.outputs.failed == 'true' || steps.check.outputs.filesize != '0'
        uses: tsickert/discord-webhook@v4.0.0
        with:
          webhook-url: ${{ secrets.validationWebhook }}
          filename: output.txt
          content: >
            Hey ${{ steps.discord.outputs.discord_name }},
            there was a problem validating your last plugin commit
            on branch ${{ github.ref }}.

      - name: Send success discord message
        if: steps.validate.outputs.failed == 'false' && steps.previous.outputs.previous_failed == 'true'
        uses: tsickert/discord-webhook@v4.0.0
        with:
          webhook-url: ${{ secrets.validationWebhook }}
          content: >
            All of the issues on branch ${{ github.ref }} are now fixed! ðŸŽ‰
