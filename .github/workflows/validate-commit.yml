name: validate-commit
on: [push]

jobs:
  validate-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Report branch info
        run: echo "Detected push to ${{ github.ref }} by $GITHUB_ACTOR"

      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Validate the plugin
        id: validate
        run: |
          set +e
          python3 missingCardFinder.py > output.txt 2> error.txt
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            {
              echo "âŒ Plugin validation crashed"
              echo
              echo "Exit code: $EXIT_CODE"
              echo
              echo "Error output:"
              cat error.txt
            } > output.txt
            echo "failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

          cat output.txt

      - name: Check for output
        id: check
        run: |
          FILESIZE=$(wc -c < output.txt)
          echo "filesize=$FILESIZE" >> "$GITHUB_OUTPUT"

      - name: Find Discord user
        id: discord
        run: |
          USERCODE=$(jq -r --arg actor "$GITHUB_ACTOR" '.[$actor]' .github/workflows/usernames.json)
          echo "discord_name=$USERCODE" >> "$GITHUB_OUTPUT"

      - name: Check previous workflow result
        id: previous
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PREV_CONCLUSION=$(gh api repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml/runs -f branch=${{ github.ref_name }} --jq '.workflow_runs[1].conclusion')

          if [ "$PREV_CONCLUSION" = "failure" ]; then
            echo "previous_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "previous_failed=false" >> "$GITHUB_OUTPUT"
          fi


      - name: Send error discord message
        if: steps.validate.outputs.failed == 'true' || steps.check.outputs.filesize != '0'
        uses: tsickert/discord-webhook@v4.0.0
        with:
          webhook-url: ${{ secrets.validationWebhook }}
          filename: output.txt
          content: >
            Hey ${{ steps.discord.outputs.discord_name }},
            there was a problem validating your last plugin commit
            on branch ${{ github.ref }}.

      - name: Send success discord message
        if: steps.validate.outputs.failed == 'false' && steps.previous.outputs.previous_failed == 'true'
        uses: tsickert/discord-webhook@v4.0.0
        with:
          webhook-url: ${{ secrets.validationWebhook }}
          content: >
            All of the issues on branch ${{ github.ref }} are now fixed! ðŸŽ‰
